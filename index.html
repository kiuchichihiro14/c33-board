<!DOCTYPE html>
<html>
  <head>
    <title>chihiroç°¡æ˜“æ²ç¤ºæ¿</title>
    <meta charset="utf-8">
    <style>
      header, footer {
        background-color: #ddd;
        padding: 1rem;
        text-align: center;
      }
      .setumei1 {
        background-color: yellow;
        display: inline;
      }
      .toukou {
        border: 1px solid #333;
        padding: 5px;
        background-color: #f2f2f2;
      }
      .coment {
        border: 1px solid #333;
        padding: 5px;
        background-color: #aaa;
      }
      .sabisii {
        color: #999;
      }
    </style>
  </head>
  <body>
    <h2>c33ç°¡æ˜“æ²ç¤ºæ¿ã€€ã€€ã€€Ver.1.0</h2>
    <h4 id="userCount">ç¾åœ¨ã®å‚åŠ è€…æ•°: 0äºº</h4>
    <h2>å’æ¥­ã¾ã§ : <span id="countdown"></span></h2>

    <header>
      <h1>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ²ç¤ºæ¿ã«ã‚ˆã†ã“ã!</h1>
    </header>

    <h5>
      chihiroãŒé©å½“ã«ä½œã‚Šã¾ã—ãŸã€‚<br>ãªã‚“ã‹é©å½“ã«éŠã‚“ã§ã£ã¦ãã ã•ã„ã€‚
    </h5>

    <h1>ã‚ã‚“ã¾ã‚Šæ²»å®‰æ‚ªã„ã¨ã€ã‚µãƒè½ã¨ã—ã¾ã™</h1>

    <h4>ãƒ«ãƒ¼ãƒ«â†“</h4>
    <h5>
      <span class="setumei1">
        æš´åŠ›çš„ãªè¨€è‘‰ã€æ±šã„(å‘çŒ¥ãª)è¨€è‘‰ã€ã¾ãŸã¯ç‰¹å®šã®èª°ã‹ã‚’éé›£ã™ã‚‹è¨€è‘‰
      </span>
      ã¯æ›¸ãè¾¼ã¾ãªã„ã§ãã ã•ã„!
    </h5>

    <h5>
      ã“ã®ã‚µãƒ¼ãƒãƒ¼ã¯
      <span class="setumei1">
        ç¤¾ä¼šã®æˆæ¥­æ™‚ã€ç·åˆã®æˆæ¥­æ™‚åŠã³åƒå°‹ã®æ°—ãŒå‘ã„ã¦ã„ã‚‹ã¨ã
      </span>
      ã«å…¬é–‹ã•ã‚Œã¾ã™ã€‚
    </h5>

    <h5 class="sabisii">
      æœ€è¿‘èª°ã‚‚æŠ•ç¨¿ã—ã¦ãã‚Œãªãã¦å¯‚ã—ã„ã®ã§æŠ•ç¨¿ã—ã¦â€¦
    </h5>

    <h5>
      ã€Œã“ã‚“ãªæ„Ÿã˜ã«å¤‰ãˆã¦!!ã€ã¯ã€Œãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ã¨ã„ã†åå‰ã§æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚
    </h5>

    <div class="coment">
      <ul id="messages"></ul>
    </div>

    <button onclick="toggleOldMessages()">éå»ã®æŠ•ç¨¿ã‚’è¡¨ç¤º / éè¡¨ç¤º</button>

    <h3>æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ â†“</h3>
    <div class="toukou">
      <input id="name" placeholder="åå‰ï¼ˆ15æ–‡å­—ä»¥å†…ï¼‰" maxlength="30"><br>
      <textarea id="msg" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ30æ–‡å­—ä»¥å†…ï¼‰" maxlength="100"></textarea><br>
      <button onclick="sendMessage()">æŠ•ç¨¿</button><br>
    </div>

    <footer>
      <h5>chihiro ga tukuri masita.</h5>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSy...",
        authDomain: "chihirokeizibann.firebaseapp.com",
        projectId: "chihirokeizibann",
        storageBucket: "chihirokeizibann.firebasestorage.app",
        messagingSenderId: "292382885477",
        appId: "1:292382885477:web:7abe43da06f062d890288c"
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const msgRef = db.collection("messages");
      const onlineRef = db.collection("online_users");

      const myOnlineDoc = onlineRef.doc();
      myOnlineDoc.set({
        online: true,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      setInterval(() => {
        myOnlineDoc.update({
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      }, 5000);

      window.addEventListener("beforeunload", () => {
        myOnlineDoc.delete();
      });

      let showOldMessages = false;
      let oldMessagesCache = [];
      let currentNewMessages = [];

      function toggleOldMessages() {
        showOldMessages = !showOldMessages;
        renderMessages(currentNewMessages, oldMessagesCache);
      }

      // ğŸ”¥ å®‰å…¨ãªã‚¿ã‚°å¤‰æ›
      function formatText(text) {
        text = text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");

        text = text
          .replace(/&lt;b&gt;(.*?)&lt;\/b&gt;/g, "<strong>$1</strong>")
          .replace(/&lt;r&gt;(.*?)&lt;\/r&gt;/g, "<span style='color:red;'>$1</span>")
          .replace(/&lt;y&gt;(.*?)&lt;\/y&gt;/g, "<span style='color:gold;'>$1</span>");

        return text;
      }

      function renderMessages(newMessages, oldMessages) {
        const list = document.getElementById("messages");
        list.innerHTML = "";

        function createMessageElement(text) {
          const li = document.createElement("li");
          const match = text.match(/^(.*?): (.*) \((.*)\)$/);

          if (match) {
            const name = formatText(match[1]);
            const message = formatText(match[2]);
            const time = match[3];

            li.innerHTML = `<strong>${name}</strong>: ${message} (${time})`;
          } else {
            li.innerHTML = formatText(text);
          }

          return li;
        }

        if (showOldMessages) {
          oldMessages.forEach(text => {
            list.appendChild(createMessageElement(text));
          });
        }

        newMessages.forEach(text => {
          list.appendChild(createMessageElement(text));
        });
      }

      msgRef.orderBy("time", "desc").onSnapshot(snapshot => {
        const newMessages = [];
        const oldMessages = [];

        snapshot.docs.forEach((doc, index) => {
          const data = doc.data();
          const now = new Date();
          const postedTime = data.time ? data.time.toDate() : null;
          let timeText = "æ™‚åˆ»ä¸æ˜";

          if (postedTime) {
            const diffMs = now - postedTime;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);

            if (diffSec < 60) timeText = `${diffSec}ç§’å‰`;
            else if (diffMin < 60) timeText = `${diffMin}åˆ†å‰`;
            else if (diffHour < 24) timeText = `${diffHour}æ™‚é–“å‰`;
            else timeText = `${diffDay}æ—¥å‰`;
          }

          const text = `${data.name}: ${data.message} (${timeText})`;

          if (index < 100) newMessages.unshift(text);
          else oldMessages.unshift(text);
        });

        oldMessagesCache = oldMessages;
        currentNewMessages = newMessages;
        renderMessages(currentNewMessages, oldMessagesCache);
      });

      onlineRef.onSnapshot(snapshot => {
        const now = new Date();
        let count = 0;

        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.timestamp && (now - data.timestamp.toDate()) < 60000) {
            count++;
          }
        });

        document.getElementById("userCount").textContent =
          `ç¾åœ¨ã®å‚åŠ è€…æ•°: ${count}äºº`;
      });

      const NG_WORDS = [
        "ãã‚“ã«","ã‚¯ãƒ³ãƒ‹","ã¾ã‚“ã“","ã¡ã‚“ã“","ã‚ãªã‚‹","ã‚¢ãƒŠãƒ«",
        "ã‚¯ãƒªãƒˆãƒªã‚¹","ãã‚Šã¨ã‚Šã™","ã’ã„","ã‚²ã‚¤","ãˆã‚","ã‚¨ãƒ­",
        "ä½“ä½","ã„ã","ã‚¤ã‚¯","ã‚¤ã‚­","ã„ã"
      ];

      function sendMessage() {
        const name = document.getElementById("name").value.trim();
        const msg = document.getElementById("msg").value.trim();

        if (!name || !msg) {
          alert("åå‰ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
          return;
        }

        if (name.length > 15) {
          alert("åå‰ã¯15æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„ï¼");
          return;
        }

        if (msg.length > 30) {
          alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯30æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„ï¼");
          return;
        }

        for (const word of NG_WORDS) {
          if (msg.includes(word) || name.includes(word)) {
            alert(`NGãƒ¯ãƒ¼ãƒ‰ã€Œ${word}ã€ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼`);
            return;
          }
        }

        msgRef.add({
          name: name,
          message: msg,
          time: firebase.firestore.FieldValue.serverTimestamp()
        });

        document.getElementById("msg").value = "";
      }

      const graduationDate = new Date("2026-03-10T10:00:00");

      function updateCountdown() {
        const now = new Date();
        const diffMs = graduationDate - now;

        if (diffMs <= 0) {
          document.getElementById("countdown").textContent = "å’æ¥­ãŠã‚ã§ã¨ã†ï¼ğŸ‰";
          return;
        }

        const diffSec = Math.floor(diffMs / 1000);
        const days = Math.floor(diffSec / (60 * 60 * 24));
        const hours = Math.floor((diffSec % (60 * 60 * 24)) / (60 * 60));
        const minutes = Math.floor((diffSec % (60 * 60)) / 60);
        const seconds = diffSec % 60;

        document.getElementById("countdown").textContent =
          `${days}æ—¥ ${hours}æ™‚é–“ ${minutes}åˆ† ${seconds}ç§’`;
      }

      setInterval(updateCountdown, 1000);
      updateCountdown();
    </script>
  </body>
</html>


